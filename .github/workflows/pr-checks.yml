name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        run: |
          echo "files_changed=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)" >> $GITHUB_OUTPUT
          echo "lines_added=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{s+=$1} END {print s}')" >> $GITHUB_OUTPUT
          echo "lines_deleted=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{s+=$2} END {print s}')" >> $GITHUB_OUTPUT

      - name: Comment PR info
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä Pull Request Statistics
              
              - **Files changed**: ${{ steps.pr-info.outputs.files_changed }}
              - **Lines added**: ${{ steps.pr-info.outputs.lines_added }}
              - **Lines deleted**: ${{ steps.pr-info.outputs.lines_deleted }}
              
              **Automated checks are running...** ‚è≥`
            })

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Check for console.log statements
        run: |
          if grep -r "console.log" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "‚ö†Ô∏è Warning: console.log statements found"
            exit 0
          fi
        continue-on-error: true

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          badges-directory: badges
          generate-branches-badge: true
          generate-summary: true
        continue-on-error: true

      - name: Comment test coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let coverage = 'N/A';
            try {
              const summary = fs.readFileSync('./coverage/coverage-summary.json', 'utf8');
              const data = JSON.parse(summary);
              coverage = data.total.lines.pct + '%';
            } catch (e) {
              console.log('Coverage file not found');
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚úÖ Test Coverage: ${coverage}
              
              View detailed coverage report in the workflow artifacts.`
            })
        continue-on-error: true

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Check project size
        run: |
          # Check node_modules size
          NODE_MODULES_SIZE=$(du -sh node_modules/ | cut -f1)
          echo "NODE_MODULES_SIZE=$NODE_MODULES_SIZE" >> $GITHUB_ENV

          # Count dependencies
          DEPS_COUNT=$(cat package.json | grep -c '".*":' || echo "0")
          echo "DEPS_COUNT=$DEPS_COUNT" >> $GITHUB_ENV

          echo "üì¶ Node modules size: $NODE_MODULES_SIZE"
          echo "üìö Dependencies count: $DEPS_COUNT"

      - name: Comment project size
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üì¶ Project Size Check
              
              - **Node modules size**: ${process.env.NODE_MODULES_SIZE}
              - **Dependencies count**: ${process.env.DEPS_COUNT}
              
              ‚ÑπÔ∏è *Note: Web bundle size check skipped (native dependencies issue in CI)*`
            })
        continue-on-error: true
